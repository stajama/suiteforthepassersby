{% load static %}
<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
	<title>Suite for the Passersby</title>
    	<style>
            body {
                background-color: #140303;
            }
        </style>
	<h1 style="font-size:4vw; font-family:superclarendon;"><font color="#fafcd6">Suite for the Passersby</font></h1>
</head>
    <body>
        <p style="font-size:2vw; font-family:superclarendon;">
            <font color="#1e6b7f">
                <em>You are listening to...</em>
                <p id='title'>Title Here</p>
                <p id="sculpture">Sculpture Name</p>
            </font>
        </p>

        <button id="start">Play</button>
        <button id="stop">Stop</button>

        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.0.15/howler.js"></script>
        <script type="text/javascript">
            /* Script uses HTML5 Geolocation to get regular GPS location updates 
            from end-user devices. When initialized, piece1 (The Promenade) will
            play until the user's geolocation is within the specified trigger 
            distance of the desired piece. The function geosuccess contains logic
            to transition to the desired piece.
            */


            const MAX_VOLUME = 1.0;
            const MIN_VOLUME = 0.0;
            const TRANSITION_TIME = 6; // This variable controls the crossfade time when a piece transition is triggered.
            var transitioning = false;
            var currentlyPlaying = 0;
            
            // LOGGING
            /* Post request tool for logging event 9/28. Code related to the 
            event will be proceeded by the commented "LOGGING" line.
            */
            var LOGGING_ID;
            var xhr = new XMLHttpRequest();
            // xhr.open('GET', "https://www.suiteforthepassersby.com/logging", true);
            xhr.open('GET', "http://127.0.0.1/logging", true);
            xhr.send();
            xhr.onreadystatechange = processRequest;
            async function processRequest(e) {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var response = JSON.parse(xhr.responseText);
                    LOGGING_ID = response.id;
                    console.log('id set: ' + LOGGING_ID);
                }
            };

            // LOGGING
            /* Function for sending log data post. Structure:
            LOGGING_ID, geoLat, getLong, active text, */
            async function sendLoggingData(LOGGING_ID, startPos, action) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', "https://www.suiteforthepassersby.com/logging/" + LOGGING_ID + '/' + startPos.coords.latitude + '/' + startPos.coords.longitude + '/' + action, true);
                var sent = "http://127.0.0.1:8000/logging/" + LOGGING_ID + '/' + startPos.coords.latitude + '/' + startPos.coords.longitude + '/' + clean_strings(action);
                console.log(sent);
                xhr.open('GET', sent, true);
                xhr.send();
            }

            // var last_position = {'lat': null, 'lon': null};
            // const MAX_DIFF = 3; // Will through out results over this distance (eliminate eradicate data).

            /* These variables are all Howler objects of the desired tracks of 
            music for the entire piece. piece1 should be The Promenade to achieve 
            the desired effect.
            */

            var standingFigures = {"name": "Standing Figures",
                                   "lat": [39.045812],
                                   "lon": [-94.581534],
                                   "audio": "{% static "Headless_Figures.mp3" %}",
                                   "title": "Headless Figures",
                                   "trigger": [38.1],
                                   "startTime": 0};

            var rumi = {"name": "Rumi",
                        "lat": [39.045879],
                        "lon": [-94.580090],
                        "title": "Love is a Madman",
                        "trigger": [45.72],
                        "startTime": 0,
                        "audio": "{% static "Love_is_a_Madman.mp3" %}"};

            var ferment = {"name": "Ferment",
                           "lat": [39.042758],
                           "lon": [-94.579753],
                           "title": "Broken",
                           "trigger": [57.912],
                           "startTime": 0,
                           "audio": "{% static "Broken.mp3" %}"};

            var shuttlecockN = {"name": "North ShuttleCock",
                                "lat": [39.043357],
                                "lon": [-94.581032],
                                "title": "Oda a La Vanguardia",
                                "trigger": [44.196],
                                "startTime": 0,
                                "audio": "{% static "Oda_a_la_Vanguardia.mp3" %}"};

            var shuttlecockS = {"name": "South ShuttleCock",
                                "lat": [39.042691],
                                "lon": [-94.581066],
                                "title": "Fireflies in the Garden",
                                "trigger": [44.196],
                                "startTime": 0,
                                "audio": "{% static "Voice_Transition.mp3" %}"};

            /* promenade and shuttleTransition do not have trigger radii or
            reasonable coordinate locations. The desired functionality is that
            promenade be performed whenever the user is not in proximity of
            any sculpture and that the transition music is only play when the
            user is located in the overlapping radii of the Northern and
            Southern shuttlecocks. In checks not related to these two locations,
            calculations are skipped when the first lat/lon values == 0/0.
            */
            var shuttleTransition = {"name": "Transition",
                                      "title": "Both light and shadow",
                                      "startTime": 0,
                                      "audio": "{% static "Voice_Transition.mp3" %}",
                                      "lat": [0],
                                      "lon": [0]};

            var promenade = {"name": "Promenade",
                                      "title": "Promenade",
                                      "startTime": 0,
                                      "audio": get_howl("{% static "Promenade.mp3" %}"), 
                                      "lat": [0],
                                      "lon": [0]};

            var rooftop = {"name": "Bloch Rooftop, 'Turbo,' or 'Ferryman'",
                            "title": "Big Muddy",
                            "startTime": 0,
                            "audio": "{% static "Big_Muddy.mp3" %}",
                            "lat": [39.043987, 39.043743],
                            "lon": [-94.579814, -94.579809],
                            "trigger": [28.956, 30.48]};

            var fourMotives1 = {"name": "Henry Moore Sculptures",
                            "title": "To Cast Four Motives",
                            "startTime": 0,
                            "audio": "{% static "To_Cast_Four_Motives.mp3" %}",
                            "lat": [39.042582, 39.04288, 39.043271, 39.043560, 39.043824],
                            "lon": [-94.581893, -94.581829, -94.581797, -94.581807, -94.581822],
                            "trigger": [30.48, 28.956, 28.956, 28.956, 27.432]};

            /* Deprecated Functionality:
            The array 'sculptures' was previously used to iterate through all
            available pieces. This has since changed. This array has only been
            maintained to keep testing UI data available without too much refactoring
            for a temporary debugging measure.
            */
            var sculptures = [rooftop, fourMotives1, standingFigures, rumi, ferment, shuttlecockS,
                                shuttlecockN, shuttleTransition, promenade];


            // check for Geolocation support
            console.log('1')
            if (navigator.geolocation) {
                console.log('Geolocation is supported!');
            }
            else {
                console.log('Geolocation is not supported for this Browser/OS.');
                // It may be useful to the end-user to redirect them to a page stating
                // that Geolocation is required for the full experience. This is also
                // a suitable place to offer the option to go to a page with just
                // buttons that trigger each piece/track with information about when
                // to do so.
            }
            // console.log('2')

            /* Main FUnction. Must either start window.onload (should be 
            possible thanks to Howler override of DOM exceptions) or through 
            a button.onclick or similar user-initiated event.
            */
            
            document.getElementById('start').onclick = async function() {
                var startPos;
                promenade['audio'].play();
                var button = document.getElementById('start');
                button.innerHTML = 'PLEASE REFRESH TO RESTART';
                button.disabled = true;

                var geoOptions = {
                    enableHighAccuracy: true
                };
                console.log('3');

                var geoSuccess = async function(position) {
                    startPos = position;

                    // IMPORTANT !!!!!! IMPORTANT 
                    /* Any additional tracks/pieces must have their 
                    respective dictionary added to this array. This 
                    excludes The Promenade and the Shuttlecock Transition music.
                    */
                    


                    if (!transitioning) {
                        var changed = false;
                        // if in range of both Shuttlecocks: play transition music
                        if (calculateDistance(startPos.coords, shuttlecockN["lat"], shuttlecockN["lon"]) <= shuttlecockN["trigger"] && 
                            calculateDistance(startPos.coords, shuttlecockS["lat"], shuttlecockS["lon"]) <= shuttlecockS["trigger"]) {
                            document.getElementById('title').innerHTML = "Both light and shadow";
                            document.getElementById('sculpture').innerHTML = "between the Shuttlecocks";
                            if (typeof shuttleTransition["audio"] == 'string') {
                                shuttleTransition['audio'] = get_howl(shuttleTransition['audio']);
                            }
                            if (!shuttleTransition["audio"].playing() ) {
                                for (var j = 0; j < sculptures.length; j++) {
                                    if (typeof sculpture[j]['audio'] == 'string') {
                                        continue;
                                    } else if (sculptures[j]["audio"].playing()) {
                                        transitioning = true;
                                        // console.log("starting " + shuttleTransition["title"] + " at " + shuttleTransition["startTime"]);
                                        shuttleTransition["audio"].seek(shuttleTransition["startTime"]);
                                        // await sculptures[i]["audio"].once('load', function () {return;});
                                        shuttleTransition["audio"].play();
                                        // console.log('actual object seek time: ' + shuttleTransition["audio"].seek());
                                        shuttleTransition["audio"].fade(MIN_VOLUME, MAX_VOLUME, 1000 * TRANSITION_TIME);
                                        sculptures[j]["audio"].fade(MAX_VOLUME, MIN_VOLUME, 1000 * TRANSITION_TIME);
                                        await sleep(1000 * TRANSITION_TIME);
                                        // console.log("stopping " + sculptures[j]["title"] + " at " + sculptures[j]["audio"].seek());
                                        sculptures[j]["startTime"] = sculptures[j]["audio"].seek();
                                        sculptures[j]["audio"].pause();
                                        transitioning = false;
                                        changed = true;
                                        sendLoggingData(LOGGING_ID, startPos, 'changed_to_transition_from_' + sculptures[j]["title"], true);
                                        return;
                                    }
                                }
                            } else {
                                changed = true;
                                sendLoggingData(LOGGING_ID, startPos, 'transition_already_playing', true);
                            }
                        }

                        // console.log("transition tested");
                        /* if NOT changing to transition music, iterate through each 
                        sculpture. If the user is in range of a new sculpture, change 
                        to that respective piece/track.
                        */
                        if (!changed) {
                            for (var i = 0; i < sculptures.length; i++) {
                                if (sculptures[i]["lat"][0] == 0 && sculptures[i]["lon"][0] == 0)  {
                                    continue;
                                } else {
                                    for (var posr = 0; posr < sculptures[i]['lat'].length; posr++) {
                                        if (calculateDistance(startPos.coords, sculptures[i]["lat"][posr], sculptures[i]["lon"][posr]) <= sculptures[i]["trigger"][posr]) {
                                            document.getElementById('title').innerHTML = sculptures[i]['title'];
                                            document.getElementById('sculpture').innerHTML = sculptures[i]['name'];
                                            if (typeof sculptures[i]['audio'] == 'string') {
                                                sculptures[i]['audio'] = get_howl(sculptures[i]['audio']);
                                            }
                                            if (!sculptures[i]["audio"].playing()) {
                                                for (var j = 0; j < sculptures.length; j++) {
                                                    console.log(sculptures[j]['audio']);
                                                    if (typeof sculptures[j]['audio'] == 'string') {
                                                        continue;
                                                    } else if (sculptures[j]["audio"].playing()) {
                                                        transitioning = true;
                                                        changed = true;
                                                        // console.log("starting " + sculptures[i]["title"] + " at " + sculptures[i]["startTime"]);
                                                        sculptures[i]["audio"].seek(sculptures[i]["startTime"]);
                                                        // await sculptures[i]["audio"].once('load', function () {console.log('jobs done'); return;});
                                                        // console.log('actual object seek time: ' + sculptures[i]["audio"].seek());
                                                        sculptures[i]['audio'].once('load', async function () {
                                                            console.log("play started");
                                                            sculptures[i]['audio'].play();
                                                            sculptures[i]["audio"].fade(MIN_VOLUME, MAX_VOLUME, 1000 * TRANSITION_TIME);
                                                            sculptures[j]["audio"].fade(MAX_VOLUME, MIN_VOLUME, 1000 * TRANSITION_TIME);
                                                            await sleep(1000 * TRANSITION_TIME);
                                                            // console.log("stopping " + sculptures[j]["title"] + " at " + sculptures[j]["audio"].seek());
                                                            sculptures[j]["startTime"] = sculptures[j]["audio"].seek();
                                                            sculptures[j]["audio"].pause();
                                                            // console.log('LOOK: ' + sculptures[j]["audio"].seek());
                                                            transitioning = false;});
                                                        sendLoggingData(LOGGING_ID, startPos, 'changed_to_' + sculptures[i]["title"] + '_from_' + sculptures[j]["title"], true);
                                                        return;
                                                    }
                                                }
                                            } else {
                                                changed = true;
                                                sendLoggingData(LOGGING_ID, startPos, sculptures[i]['title'] + '_already_playing', true);
                                                return;
                                            }
                                        }
                                    }

                                }
                            }
                        }
                        // console.log("allMusic tested");

                        /* if NOT changing to transition music AND NOT changing 
                        to another piece, play The Promenade music.
                        */
                        if (!changed) {
                            document.getElementById('title').innerHTML = "Promenade";
                            document.getElementById('sculpture').innerHTML = "";
                            if (!promenade["audio"].playing()) {
                                for (var j = 0; j < sculptures.length; j++) {
                                    if (typeof sculptures[j]['audio'] == 'string') {
                                        continue;
                                    } else if (sculptures[j]["audio"].playing()) {
                                        transitioning = true;
                                        // console.log("starting " + promenade["title"] + " at " + promenade["startTime"]);
                                        promenade["audio"].seek(promenade["startTime"]);
                                        // await promenade["audio"].once('load', function () {return;});
                                        promenade["audio"].play();
                                        // console.log('actual object seek time: ' + promenade["audio"].seek());  
                                        promenade['audio'].once('play', async function () { 
                                            promenade["audio"].fade(MIN_VOLUME, MAX_VOLUME, 1000 * TRANSITION_TIME);
                                            sculptures[j]["audio"].fade(MAX_VOLUME, MIN_VOLUME, 1000 * TRANSITION_TIME);
                                            await sleep(1000 * TRANSITION_TIME);
                                            // console.log("stopping " + sculptures[j]["title"] + " at " + sculptures[j]["audio"].seek());
                                            sculptures[j]["startTime"] = sculptures[j]["audio"].seek();
                                            sculptures[j]["audio"].pause();
                                            // console.log('LOOK: ' + sculptures[j]["audio"].seek());
                                            transitioning = false;
                                        });
                                        sendLoggingData(LOGGING_ID, startPos, 'changed_to_promenade_from_' + sculptures[j]["title"], true);
                                        return;
                                    }
                                }
                            } else {sendLoggingData(LOGGING_ID, startPos, 'promenade_already_playing', true);}
                        };
                    } else {
                        // console.log("transition being blocked");
                        sendLoggingData(LOGGING_ID, startPos, 'transition_being_blocked', true);
                    };
                };

                var geoError = function(error) {
                    console.log('Error occurred. Error code: ' + error.code);
                    // error.code can be:
                    //   0: unknown error
                    //   1: permission denied
                    //   2: position unavailable (error response from location provider)
                    //   3: timed out
                };

                /* Function starts with this call. watchPosition() regularly updates, calling
                geoSuccess if user Geolocation data is successfully received, causing a constant
                loop of the main functionality of the app.
                */
                navigator.geolocation.watchPosition(geoSuccess, geoError, geoOptions);
            };
            console.log('time to worry if otherwise blank');

            /* Function for calculating users-position from a sculpture. 
            Math and code explained better at 
            https://www.movable-type.co.uk/scripts/latlong.html
            */
            function calculateDistance(currentPosition, targetPositionLat, targetPositionLon) {
                const R = 6371e3; // earth's radius (const)
                var phi1 = currentPosition.latitude * (Math.PI / 180);
                var phi2 = targetPositionLat * (Math.PI / 180);
                var deltaphi = (targetPositionLat - currentPosition.latitude) * (Math.PI / 180);
                var deltalambda = (targetPositionLon - currentPosition.longitude) * (Math.PI / 180);

                var a = Math.sin(deltaphi / 2) * Math.sin(deltaphi / 2) +
                        Math.cos(phi1) * Math.cos(phi2) *
                        Math.sin(deltalambda / 2) * Math.sin(deltalambda / 2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                var d = R * c;
                return d;
            };

            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // IMPORTANT !!!!!!!!!!! IMPORTANT !!!!!!!!!!!!!
            /* This function is tied to the Emergency Stop button. It simply stops 
            all Howler objects from playing in the off chance that something goes 
            horribly wrong. Any new Howler objects must be added to the this 
            function.
            */
            document.getElementById('stop').onclick = function() {
                for (i = 0; i < sculptures.length; i++) {
                    sculptures[i]["audio"].pause()
                }
            };

            function clean_strings(string) {
                var output = "";
                for (var i = 0; i < string.length; i++) {
                    if (string.charAt(i) == ' ') {
                        output = output + '_';
                    } else {
                        output = output + string.charAt(i);
                    }
                }
                return output;
            }

            function get_howl(uri) {
                var x = new Howl({
                    src: uri,
                    loop: true,
                    html5: true,
                });
                return x;
            }
            
        </script>
    </body>
</html>

